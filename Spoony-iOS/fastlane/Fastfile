# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc "Build app and upload to TestFlight"

  #########################################
  # âœ… ëª¨ë“  lane ì„±ê³µ ì‹œ í˜¸ì¶œ
  #########################################
  after_all do |lane|
    send_discord_message("â­ï¸ TestFlight ì—…ë¡œë“œ ì„±ê³µ!", true)
  end

  #########################################
  # ğŸš¨ ì—ëŸ¬ ë°œìƒ ì‹œ í˜¸ì¶œ
  #########################################
  error do |lane, exception|
    send_discord_message("âŒ TestFlight ì—…ë¡œë“œ ì‹¤íŒ¨\n\nì—ëŸ¬ ë‚´ìš©: #{exception.message}", false)
  end

  #########################################
  # ğŸ” í‚¤ì²´ì¸ ìƒì„± lane
  #########################################
  lane :setup_keychain do
    create_keychain(
      name: ENV["KEYCHAIN_NAME"],
      password: ENV["KEYCHAIN_PASSWORD"],
      timeout: 1800,
      default_keychain: true,
      unlock: true,
      lock_when_sleeps: false
    )
  end

  #########################################
  # ğŸ›  Match lane
  #########################################
  lane :setup_match do
    match(
      git_url: ENV["PRIVATE_REPOSITORY"],
      storage_mode: "git",
      type: "appstore",
      readonly: true,
      keychain_name: ENV["KEYCHAIN_NAME"],
      keychain_password: ENV["KEYCHAIN_PASSWORD"]
    )
  end

  #########################################
  # ğŸ“¦ í…ŒìŠ¤íŠ¸í”Œë¼ì´íŠ¸ ë°°í¬ lane
  #########################################
  lane :beta do
    # 1ï¸âƒ£ Keychain ì„¤ì •
    setup_keychain

    # 2ï¸âƒ£ Match ì¸ì¦ì„œ/í”„ë¡œë¹„ì €ë‹ ì„¤ì •
    setup_match

    # 3ï¸âƒ£ ë¹Œë“œ ë„˜ë²„ ì„¤ì • (ë‚ ì§œ ê¸°ë°˜)
    build_number = date_based_build_number
    increment_build_number(
      build_number: build_number
    )

    # 4ï¸âƒ£ API Key ë°©ì‹ TestFlight ì—…ë¡œë“œ
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
    ) 

    # 5ï¸âƒ£ ì•± ë¹Œë“œ
    build_app(
      workspace: "Spoony-iOS/Spoony.xcworkspace",
      scheme: "Spoony-iOS",
      configuration: "Release"
    )

    # 6ï¸âƒ£ TestFlight ì—…ë¡œë“œ
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end

  #########################################
  # ğŸ”” Discord ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
  #########################################
  def send_discord_message(message, success)
    version = get_version_number(xcodeproj: "Spoony.xcodeproj")
    build_number = get_build_number(xcodeproj: "Spoony.xcodeproj")
    title_text = success ? "ğŸš€ TestFlight ì—…ë¡œë“œ ì„±ê³µ" : "ğŸš¨ TestFlight ì—…ë¡œë“œ ì‹¤íŒ¨"

    discord_notifier(
      webhook_url: ENV["SPOONY_DISCORD"],
      title: "#{title_text} â€” v#{version} (#{build_number})",
      description: message,
      success: success
    )
  end

  #########################################
  # ğŸ—“ ë‚ ì§œ ê¸°ë°˜ ë¹Œë“œ ë²ˆí˜¸
  #########################################
  def date_based_build_number
    Time.new.strftime("%Y.%m%d.%H%M")
  end
end
