# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: TestFlight 

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: CI/CD By Using Fastlane
    runs-on: macos-latest

    steps:
    # 1Ô∏è‚É£ Ï≤¥ÌÅ¨ÏïÑÏõÉ
    - name: 1Ô∏è‚É£ Checkout
      uses: actions/checkout@v4
      
    # 2Ô∏è‚É£ Xcode Version ÏÑ§Ï†ï
    - name: 2Ô∏è‚É£ Setting Xcode Version
      run: sudo xcode-select -s /Applications/Xcode_16.4.app
    
    - name: üßπ Clean DerivedData
      run: rm -rf ~/Library/Developer/Xcode/DerivedData
      
    - name: Resolve Dependencies
      run: xcodebuild -resolvePackageDependencies -project Spoony-iOS/Spoony.xcodeproj

    - name: Skip Macro Validation
      run: |
        defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES
        defaults write com.apple.dt.Xcode IDESkipPackagePluginFingerprintValidation -bool YES
    
    # 3Ô∏è‚É£ Config ÏÑ§Ï†ï
    - name: 3Ô∏è‚É£ Setting Config
      run: |
        mkdir -p Spoony-iOS/Spoony-iOS/Config
        echo "${CONFIG}" | base64 --decode > Spoony-iOS/Spoony-iOS/Config/Config.swift
        echo "KAKAO_APP_KEY = ${KAKAO_APP_KEY}" > Spoony-iOS/Spoony-iOS/Config/Config.xcconfig
      env:
        CONFIG: ${{ secrets.CONFIG }}
        KAKAO_APP_KEY: ${{ secrets.KAKAO_APP_KEY }}
    
    # 4Ô∏è‚É£ ruby ÏÑ§Ïπò
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 2.7
    
    # 5Ô∏è‚É£ fastlane ÏÑ§Ïπò
    - name: 4Ô∏è‚É£ Install fastlane
      run: brew install fastlane
    - name: Fastlane Version Check
      run: fastlane --version
      
    # 6Ô∏è‚É£ Install SSH
    - name: 5Ô∏è‚É£ SSH key ÏÑ§Ïπò
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_KEY }}
        known_hosts: ${{ secrets.KNOWN_HOSTS }}
    
    # 7Ô∏è‚É£ Run Fastlane
    - name: Run Fastlane
      run: fastlane beta
      working-directory: Spoony-iOS
      env: 
        APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
        APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        FASTLANE_ITC_TEAM_ID: ${{ secrets.FASTLANE_ITC_TEAM_ID }}
        GIT_BRANCH: ${{ secrets.GIT_BRANCH }}
        KEYCHAIN_NAME: ${{ secrets.KEYCHAIN_NAME }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        PRIVATE_REPOSITORY: ${{ secrets.PRIVATE_REPOSITORY }}
        SPOONY_DISCORD: ${{ secrets.SPOONY_DISCORD }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
